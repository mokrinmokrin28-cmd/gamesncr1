<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gems Pro - Premium System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #020617; overflow-x: hidden; }
        .hidden { display: none; }
        .sidebar { transition: transform 0.4s ease-in-out; z-index: 100; }
        .profile-overlay { backdrop-filter: blur(12px); background: rgba(0,0,0,0.8); }
        @keyframes ticker { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
        .admin-ticker { animation: ticker 20s linear infinite; white-space: nowrap; }
        .notif-badge { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: red; border-radius: 50%; border: 2px solid #000; }
        #top-popup-notif { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); z-index: 1000; transition: top 0.5s ease-in-out; width: 90%; max-width: 400px; }
        #top-popup-notif.show { top: 20px; }
        
        .prize-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 1.5rem; padding: 1rem; text-align: center; transition: all 0.3s; }
        .prize-card:hover { border-color: #eab308; transform: translateY(-5px); }
        .prize-img { width: 100%; height: 80px; object-fit: contain; margin-bottom: 0.5rem; }
    </style>
</head>
<body class="text-white">

    <div id="top-popup-notif" class="bg-yellow-500 text-black p-4 rounded-2xl shadow-2xl font-bold flex items-center gap-3">
        <i class="fas fa-bell animate-bounce"></i>
        <span id="popup-text"></span>
    </div>

    <div id="admin-notif-bar" class="hidden fixed top-0 left-0 p-1 w-full bg-yellow-500 text-black z-[100] overflow-hidden font-bold text-xs">
        <div id="new-user-ticker" class="admin-ticker">Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯...</div>
    </div>

    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-6 text-center">
        <div class="w-24 h-24 bg-yellow-500 rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-2xl animate-pulse">
            <i class="fas fa-gem text-5xl text-black"></i>
        </div>
        <h1 class="text-4xl font-black text-yellow-500 uppercase tracking-tighter mb-10">Gems Pro</h1>
        <button id="btn-login" class="flex items-center gap-4 bg-white text-black px-10 py-4 rounded-2xl font-black hover:scale-105 transition shadow-2xl">
            <img src="https://www.google.com/favicon.ico" class="w-6" alt="google">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¬Ù…Ø§ÙŠÙ„
        </button>
    </div>

    <div id="dashboard-page" class="hidden min-h-screen flex flex-col">
        <nav class="bg-gray-950/80 border-b border-gray-800/50 p-4 sticky top-0 z-50 backdrop-blur-xl flex justify-between items-center">
            <div class="flex items-center gap-2">
                <button id="open-sidebar" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-900 border border-gray-800 text-gray-400">
                    <i class="fas fa-bars-staggered text-xl"></i>
                </button>
                <button id="open-notifs" class="relative w-10 h-10 flex items-center justify-center rounded-xl bg-gray-900 border border-gray-800 text-yellow-500">
                    <i class="fas fa-bell text-lg"></i>
                    <div id="notif-dot" class="hidden notif-badge"></div>
                </button>
            </div>
            <div class="flex items-center gap-3 bg-gradient-to-b from-gray-800 to-gray-900 border border-yellow-500/20 px-6 py-2 rounded-2xl shadow-xl">
                <span id="points-count" class="text-yellow-500 font-black text-2xl tracking-tighter">0</span>
                <i class="fas fa-gem text-yellow-500 text-sm animate-pulse"></i>
            </div>
            <button id="open-profile" class="relative group">
                <img id="user-display-photo" src="" class="w-12 h-12 rounded-2xl border-2 border-gray-800 group-hover:border-yellow-500 transition-all object-cover">
            </button>
        </nav>

        <main class="flex-1 p-6 max-w-xl mx-auto w-full">
            <h3 class="text-xl font-black mb-6 flex items-center gap-2">
                <i class="fas fa-tasks text-yellow-500"></i> Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©
            </h3>
            <div id="tasks-list" class="space-y-4"></div>

            <div id="admin-panel" class="hidden mt-12 border-t border-gray-800 pt-10 pb-20">
                <h3 class="text-2xl font-black text-yellow-500 mb-6 uppercase italic text-center">Admin Panel</h3>
                <div class="grid grid-cols-2 gap-4 mb-8 text-center text-xs">
                    <div class="bg-gray-900 p-5 rounded-3xl border border-gray-800">
                        <p class="text-gray-500">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                        <p id="total-users-count" class="text-2xl font-black">0</p>
                    </div>
                    <div class="bg-gray-900 p-5 rounded-3xl border border-gray-800">
                        <p class="text-gray-500">Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</p>
                        <p id="active-users-count" class="text-2xl font-black text-green-500">1</p>
                    </div>
                </div>
                <div class="bg-gray-900 p-6 rounded-[2.5rem] border border-blue-500/20 mb-8 text-right">
                    <h4 class="font-bold mb-4 text-sm text-blue-500 italic">Ø³Ø­Ø¨ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4>
                    <div id="admin-withdraw-list" class="space-y-3"></div>
                </div>
                <div class="bg-gray-900 p-6 rounded-[2.5rem] border border-orange-500/20 mb-8 text-right">
                    <h4 class="font-bold mb-4 text-sm text-orange-500 italic">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4>
                    <div id="pending-tasks-list" class="space-y-3 text-[11px]"></div>
                </div>
                <div class="bg-gray-900 p-6 rounded-[2.5rem] border border-yellow-500/20 mb-8 text-xs">
                    <h4 class="font-bold mb-4 text-sm text-yellow-500 uppercase">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</h4>
                    <input type="text" id="new-task-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©" class="w-full bg-black border border-gray-800 p-4 rounded-2xl mb-3 outline-none">
                    <textarea id="new-task-desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="w-full bg-black border border-gray-800 p-4 rounded-2xl mb-3 outline-none h-20"></textarea>
                    <input type="url" id="new-task-url" placeholder="Ø±Ø§Ø¨Ø· OGAds" class="w-full bg-black border border-gray-800 p-4 rounded-2xl mb-3 outline-none">
                    <input type="number" id="new-task-points" placeholder="Ø§Ù„Ù†Ù‚Ø§Ø·" class="w-full bg-black border border-gray-800 p-4 rounded-2xl mb-4 outline-none">
                    <button id="add-task-confirm" class="w-full bg-yellow-500 text-black font-black py-4 rounded-2xl">Ù†Ø´Ø±</button>
                    <div id="admin-manage-tasks" class="mt-4 space-y-2 border-t border-gray-800 pt-4"></div>
                </div>
                <div id="admin-user-list" class="space-y-3 max-h-80 overflow-y-auto"></div>
            </div>
        </main>
    </div>

    <div id="notifs-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-6 profile-overlay">
        <div class="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-[2.5rem] p-6 relative">
            <button id="close-notifs" class="absolute top-4 left-4 text-gray-500"><i class="fas fa-times text-xl"></i></button>
            <h3 class="text-xl font-black mb-4 text-yellow-500 italic text-center underline">Notifications</h3>
            <div id="notifs-content" class="space-y-3 max-h-80 overflow-y-auto text-sm text-right"></div>
        </div>
    </div>

    <div id="task-detail-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-6 profile-overlay text-center">
        <div class="bg-gray-900 border border-gray-800 w-full max-w-sm rounded-[2.5rem] p-8 relative">
            <h3 id="modal-task-title" class="text-xl font-black mb-2 text-yellow-500 uppercase"></h3>
            <p id="modal-task-desc" class="text-gray-400 text-sm mb-8 leading-relaxed"></p>
            <button id="modal-start-btn" class="w-full bg-white text-black font-black py-4 rounded-2xl mb-3">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
            <button id="modal-confirm-btn" class="w-full bg-yellow-500 text-black font-black py-4 rounded-2xl">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ØªÙ…Ø§Ù…</button>
            <button onclick="document.getElementById('task-detail-modal').classList.add('hidden')" class="mt-4 text-gray-600 text-xs text-right">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="sidebar" class="sidebar fixed top-0 right-0 h-full w-80 bg-gray-950 border-l border-gray-800 shadow-2xl transform translate-x-full p-8 text-center overflow-y-auto">
        <h3 class="text-2xl font-black text-yellow-500 mb-10 italic underline">GEMS PRO MENU</h3>
        <div id="open-withdraw-btn" class="bg-gray-900 p-5 rounded-3xl border border-gray-800 mb-6 flex items-center gap-4 cursor-pointer">
            <div class="w-10 h-10 bg-yellow-500 rounded-xl flex items-center justify-center text-black"><i class="fas fa-wallet"></i></div>
            <div class="text-right"><h4 class="font-bold text-sm text-white">Ù…Ø±ÙƒØ² Ø§Ù„Ø³Ø­Ø¨</h4></div>
        </div>
        <div id="open-referral-btn" class="bg-gray-900 p-5 rounded-3xl border border-gray-800 mb-6 flex items-center gap-4 cursor-pointer text-right">
            <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center text-white"><i class="fas fa-users"></i></div>
            <div><h4 class="font-bold text-sm text-white text-right">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</h4></div>
        </div>
        <div class="mt-8 text-right border-t border-gray-800 pt-6">
            <h4 class="text-yellow-500 font-black text-xs mb-4 uppercase tracking-widest text-right"><i class="fas fa-history ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</h4>
            <div id="user-withdraw-history" class="space-y-3">
                <p class="text-gray-600 text-[10px] text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø­ÙˆØ¨Ø§Øª Ø¨Ø¹Ø¯</p>
            </div>
        </div>
        <button id="btn-logout" class="w-full p-4 bg-red-500/10 text-red-500 rounded-2xl font-bold mb-4 mt-10">Ø®Ø±ÙˆØ¬</button>
        <button id="close-sidebar" class="absolute top-8 left-8 text-gray-500"><i class="fas fa-times text-xl"></i></button>
    </div>

    <div id="referral-modal" class="hidden fixed inset-0 z-[120] flex items-center justify-center p-6 profile-overlay">
        <div class="bg-white border border-gray-200 w-full max-w-sm rounded-[2.5rem] p-8 relative text-gray-900 text-center">
            <button id="close-referral" class="absolute top-6 left-6 text-gray-400 text-xl"><i class="fas fa-times"></i></button>
            <p class="font-bold mb-4 text-right">ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
            <div class="bg-gray-200 py-3 rounded-full font-black text-xl mb-4 text-blue-600 font-mono"><span id="my-referral-code-display">...</span></div>
            <button id="copy-ref-btn" class="w-full bg-teal-600 text-white py-3 rounded-full font-bold mb-6">Ù†Ø³Ø® ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙƒÙˆØ¯</button>
            <div id="referral-input-container">
                <input type="text" id="ref-input-field" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ ØµØ¯ÙŠÙ‚Ùƒ" class="w-full bg-gray-200 rounded-full py-3 px-6 text-center font-bold mb-4 outline-none uppercase font-mono">
                <button id="confirm-ref-btn" class="w-full bg-teal-600 text-white py-3 rounded-full font-bold">ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </div>
    </div>

    <div id="withdraw-modal" class="hidden fixed inset-0 z-[120] flex items-center justify-center p-4 profile-overlay">
        <div class="bg-gray-950 border border-gray-800 w-full max-w-lg rounded-[3rem] p-6 relative max-h-[90vh] overflow-y-auto">
            <button id="close-withdraw" class="absolute top-6 left-6 text-gray-500 text-xl"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-black text-yellow-500 mb-8 text-center italic uppercase tracking-tighter">Withdraw Center</h2>
            
            <div id="prizes-grid" class="grid grid-cols-2 gap-4">
                <div class="prize-card">
                    <img src="https://cdn-icons-png.flaticon.com/512/3241/3241514.png" class="prize-img" alt="FF">
                    <h4 class="text-[11px] font-bold mb-2">110 Diamonds FF</h4>
                    <button onclick="window.requestWithdraw('110 Diamonds FF', 1000, 'Free Fire (ID)')" class="w-full bg-yellow-500 text-black py-2 rounded-xl text-[10px] font-black">1000 PT</button>
                </div>
                <div class="prize-card">
                    <img src="https://cdn-icons-png.flaticon.com/512/3241/3241514.png" class="prize-img" alt="FF">
                    <h4 class="text-[11px] font-bold mb-2">231 Diamonds FF</h4>
                    <button onclick="window.requestWithdraw('231 Diamonds FF', 2000, 'Free Fire (ID)')" class="w-full bg-yellow-500 text-black py-2 rounded-xl text-[10px] font-black">2000 PT</button>
                </div>
                <div class="prize-card">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Robux_2019_Logo_gold.svg/1200px-Robux_2019_Logo_gold.svg.png" class="prize-img" alt="Robux">
                    <h4 class="text-[11px] font-bold mb-2">80 Robux</h4>
                    <button onclick="window.requestWithdraw('80 Robux', 1200, 'Roblox (ID)')" class="w-full bg-yellow-500 text-black py-2 rounded-xl text-[10px] font-black">1200 PT</button>
                </div>
                <div class="prize-card">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Robux_2019_Logo_gold.svg/1200px-Robux_2019_Logo_gold.svg.png" class="prize-img" alt="Robux">
                    <h4 class="text-[11px] font-bold mb-2">160 Robux</h4>
                    <button onclick="window.requestWithdraw('160 Robux', 2300, 'Roblox (ID)')" class="w-full bg-yellow-500 text-black py-2 rounded-xl text-[10px] font-black">2300 PT</button>
                </div>
                <div class="prize-card">
                    <img src="https://cdn-icons-png.flaticon.com/512/1034/1034131.png" class="prize-img" alt="Recharge">
                    <h4 class="text-[11px] font-bold mb-2">10 DH Orange</h4>
                    <button onclick="window.requestWithdraw('10 DH Orange', 1100, 'Phone Number')" class="w-full bg-yellow-500 text-black py-2 rounded-xl text-[10px] font-black">1100 PT</button>
                </div>
                <div class="prize-card">
                    <img src="https://cdn-icons-png.flaticon.com/512/1034/1034131.png" class="prize-img" alt="Recharge">
                    <h4 class="text-[11px] font-bold mb-2">10 DH Maroc Telecom</h4>
                    <button onclick="window.requestWithdraw('10 DH IAM', 1100, 'Phone Number')" class="w-full bg-yellow-500 text-black py-2 rounded-xl text-[10px] font-black">1100 PT</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, collection, query, where, getDocs, onSnapshot, orderBy, limit, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDr1YPr8ZL__SPE4IU7JVZZ0WHxV2_8aU4",
            authDomain: "ncr7-d4a74.firebaseapp.com",
            projectId: "ncr7-d4a74",
            appId: "1:588530322875:web:53f602509b4ff81c99c89e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const ADMIN_EMAIL = "abdonacir22@gmail.com";
        let currentActiveTask = null;

        window.showTopNotif = (text) => {
            const el = document.getElementById('top-popup-notif');
            document.getElementById('popup-text').innerText = text;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 4000);
        };

        window.modPoints = async (id, val) => await updateDoc(doc(db, "users", id), { points: increment(val) });
        window.deleteTask = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ")) await deleteDoc(doc(db, "tasks", id)); };
        
        window.approveTask = async (reqId, userId, reward, title) => {
            try {
                await updateDoc(doc(db, "users", userId), { points: increment(reward) });
                await addDoc(collection(db, "notifications"), { userId: userId, text: `âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ù…Ù‡Ù…Ø© "${title}" ÙˆØ²ÙŠØ§Ø¯Ø© +${reward} Ù†Ù‚Ø·Ø©!`, createdAt: serverTimestamp() });
                await deleteDoc(doc(db, "pending_tasks", reqId));
                window.showTopNotif(`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ù…Ù‡Ù…Ø© ÙˆØªÙˆØ²ÙŠØ¹ ${reward} Ù†Ù‚Ø·Ø©!`);
            } catch (e) { console.error("Error:", e); }
        };

        window.rejectTask = async (id) => { if(confirm("Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ØŸ")) { await deleteDoc(doc(db, "pending_tasks", id)); window.showTopNotif("ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ù…Ù‡Ù…Ø©."); } };

        window.approveWithdraw = async (id, userId, item) => {
            try {
                await updateDoc(doc(db, "withdraw_requests", id), { status: "success" });
                await addDoc(collection(db, "notifications"), { userId, text: `ğŸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ "${item}" ØªÙ… Ø´Ø­Ù†Ù‡ Ø¨Ù†Ø¬Ø§Ø­!`, createdAt: serverTimestamp() });
                await deleteDoc(doc(db, "pending_withdraws", id));
                window.showTopNotif(`ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø´Ø­Ù† "${item}" Ø¨Ù†Ø¬Ø§Ø­!`);
            } catch (e) { console.error(e); }
        };

        window.requestWithdraw = async (item, price, promptLabel) => {
            try {
                const userRef = doc(db, "users", auth.currentUser.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.data().points < price) return alert("Ù†Ù‚Ø§Ø·Ùƒ Ù„Ø§ ØªÙƒÙÙŠ!");
                
                const playerID = prompt(`Ø£Ø¯Ø®Ù„ ${promptLabel}:`);
                if (playerID && playerID.trim() !== "") {
                    const docRef = await addDoc(collection(db, "pending_withdraws"), { 
                        userId: auth.currentUser.uid, 
                        userName: auth.currentUser.displayName, 
                        item: item, 
                        price: price, 
                        playerID: playerID, 
                        createdAt: serverTimestamp() 
                    });
                    await setDoc(doc(db, "withdraw_requests", docRef.id), { 
                        userId: auth.currentUser.uid, 
                        item: item, 
                        price: price, 
                        status: "pending", 
                        createdAt: serverTimestamp() 
                    });
                    await updateDoc(userRef, { points: increment(-price) });
                    window.showTopNotif("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„Ø£Ø¯Ù…Ù†.");
                    document.getElementById('withdraw-modal').classList.add('hidden');
                }
            } catch (err) { console.error(err); }
        };

        async function handleAuth(user) {
            const userRef = doc(db, "users", user.uid);
            let userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                const newCode = (user.displayName ? user.displayName.substring(0,3).toUpperCase() : "GEM") + Math.floor(1000 + Math.random() * 9000);
                await setDoc(userRef, { name: user.displayName, email: user.email, points: 0, referralCode: newCode, referralStepCompleted: false, createdAt: serverTimestamp() });
                userSnap = await getDoc(userRef);
            }
            const userData = userSnap.data();
            document.getElementById('login-page').classList.add('hidden'); 
            document.getElementById('dashboard-page').classList.remove('hidden');
            document.getElementById('user-display-photo').src = user.photoURL;
            document.getElementById('my-referral-code-display').innerText = userData.referralCode;
            
            if (user.email === ADMIN_EMAIL) {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-notif-bar').classList.remove('hidden');
                initAdmin();
            }
            listenToUserData(user.uid);
            listenToTasks(user.uid);
            listenToNotifications(user.uid);
            listenToWithdrawHistory(user.uid);
        }

        function initAdmin() {
            onSnapshot(collection(db, "users"), (snap) => {
                document.getElementById('total-users-count').innerText = snap.size;
                const list = document.getElementById('admin-user-list'); list.innerHTML = "";
                snap.forEach(uDoc => {
                    const u = uDoc.data();
                    list.innerHTML += `<div class="flex justify-between items-center bg-black/40 p-3 rounded-xl border border-gray-800 text-[11px] mb-2 text-right">
                        <div class="text-right"><p>${u.name}</p><p class="text-yellow-500">${u.points} PT</p></div>
                        <div class="flex gap-1"><button onclick="window.modPoints('${uDoc.id}', 10)" class="bg-green-600 w-7 h-7 rounded">+</button>
                        <button onclick="window.modPoints('${uDoc.id}', -10)" class="bg-red-600 w-7 h-7 rounded">-</button></div></div>`;
                });
            });
            onSnapshot(query(collection(db, "pending_withdraws"), orderBy("createdAt", "desc")), snap => {
                const list = document.getElementById('admin-withdraw-list'); list.innerHTML = "";
                snap.forEach(d => {
                    const p = d.data();
                    list.innerHTML += `<div class="bg-black/60 p-3 rounded-xl border border-blue-500/30 mb-2 flex justify-between items-center text-[10px] text-right">
                        <div class="text-right"><p>${p.userName} Ø·Ù„Ø¨ ${p.item}</p><p class="text-blue-500">ID: ${p.playerID}</p></div>
                        <button onclick="window.approveWithdraw('${d.id}','${p.userId}','${p.item}')" class="bg-blue-600 px-3 py-1 rounded">ØªÙ…</button></div>`;
                });
            });
            onSnapshot(query(collection(db, "pending_tasks"), orderBy("createdAt", "desc")), snap => {
                const list = document.getElementById('pending-tasks-list'); list.innerHTML = snap.empty ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª" : "";
                snap.forEach(d => {
                    const p = d.data();
                    list.innerHTML += `<div class="bg-black/60 p-3 rounded-xl border border-orange-500/30 mb-2 flex justify-between items-center text-[10px] text-right">
                        <div class="text-right"><p>${p.userName} -> ${p.taskTitle}</p></div>
                        <div class="flex gap-1"><button onclick="window.approveTask('${d.id}','${p.userId}',${p.reward},'${p.taskTitle}')" class="bg-green-600 px-2 py-1 rounded">Ù‚Ø¨ÙˆÙ„</button>
                        <button onclick="window.rejectTask('${d.id}')" class="bg-red-600 px-2 py-1 rounded">Ø±ÙØ¶</button></div></div>`;
                });
            });
            onSnapshot(collection(db, "tasks"), snap => {
                const box = document.getElementById('admin-manage-tasks'); box.innerHTML = "";
                snap.forEach(tDoc => { box.innerHTML += `<div class="flex justify-between p-1 text-right"><span>${tDoc.data().title}</span><button onclick="window.deleteTask('${tDoc.id}')" class="text-red-500 text-xs italic underline">Ø­Ø°Ù</button></div>`; });
            });
        }

        async function listenToTasks(uid) {
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø¹Ø§Ù‹
            onSnapshot(collection(db, "tasks"), async (taskSnap) => {
                const doneQ = query(collection(db, "completed_tasks"), where("userId", "==", uid));
                const doneSnap = await getDocs(doneQ);
                
                const hiddenTasks = {};
                const now = Date.now();
                
                doneSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.doneAt) {
                        const timeDiff = now - data.doneAt.toMillis();
                        // Ø¥Ø°Ø§ Ù…Ø± Ø£Ù‚Ù„ Ù…Ù† 24 Ø³Ø§Ø¹Ø© (24 * 60 * 60 * 1000 Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©)
                        if (timeDiff < 86400000) {
                            hiddenTasks[data.taskId] = true;
                        }
                    }
                });

                const container = document.getElementById('tasks-list');
                container.innerHTML = "";
                
                taskSnap.forEach(tDoc => {
                    if (hiddenTasks[tDoc.id]) return; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„Øª Ù…Ø¤Ø®Ø±Ø§Ù‹

                    const t = tDoc.data();
                    const div = document.createElement('div');
                    div.className = "bg-gray-900 border border-gray-800 p-5 rounded-[2rem] flex items-center justify-between cursor-pointer hover:border-yellow-500 transition mb-3 text-right";
                    div.innerHTML = `<div class="flex items-center gap-4 text-right"><div class="w-10 h-10 bg-yellow-500/10 rounded-2xl flex items-center justify-center text-yellow-500 text-right"><i class="fas fa-link"></i></div>
                        <div class="text-right"><h4 class="font-bold text-sm uppercase">${t.title}</h4><p class="text-[10px] text-gray-500">+${t.reward} PT</p></div></div>
                        <span class="bg-yellow-500 text-black font-black px-4 py-1 rounded-xl text-xs">+${t.reward}</span>`;
                    div.onclick = () => { 
                        currentActiveTask = { ...t, id: tDoc.id }; 
                        document.getElementById('modal-task-title').innerText = t.title; 
                        document.getElementById('modal-task-desc').innerText = t.description || "Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø·"; 
                        document.getElementById('task-detail-modal').classList.remove('hidden'); 
                    };
                    container.appendChild(div);
                });
            });
        }

        function listenToWithdrawHistory(uid) {
            const q = query(collection(db, "withdraw_requests"), where("userId", "==", uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('user-withdraw-history');
                container.innerHTML = snap.empty ? "<p class='text-gray-600 text-[10px] text-center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø­ÙˆØ¨Ø§Øª Ø¨Ø¹Ø¯</p>" : "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const statusClass = d.status === 'pending' ? 'text-orange-500 italic' : 'text-green-500 font-bold';
                    const statusText = d.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 'ØªÙ…Øª Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…';
                    container.innerHTML += `<div class="bg-gray-900/50 p-3 rounded-xl border border-gray-800 text-right mb-2 text-right">
                            <div class="flex justify-between items-center mb-1 text-right">
                                <span class="text-white text-[11px] font-bold text-right">${d.item}</span>
                                <span class="text-yellow-500 text-[10px]">${d.price} PT</span>
                            </div>
                            <p class="${statusClass} text-[9px] tracking-tighter text-right">${statusText}</p>
                        </div>`;
                });
            });
        }

        function listenToNotifications(uid) {
            const q = query(collection(db, "notifications"), where("userId", "==", uid), orderBy("createdAt", "desc"), limit(1));
            onSnapshot(q, (snap) => {
                const dot = document.getElementById('notif-dot');
                if (!snap.empty) {
                    dot.classList.remove('hidden');
                    const latestNotif = snap.docs[0].data();
                    const diff = Date.now() - latestNotif.createdAt.toMillis();
                    if (diff < 10000) window.showTopNotif(latestNotif.text);
                }
                const fullQ = query(collection(db, "notifications"), where("userId", "==", uid), orderBy("createdAt", "desc"));
                getDocs(fullQ).then(s => {
                    const content = document.getElementById('notifs-content');
                    content.innerHTML = s.empty ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹" : "";
                    s.forEach(d => { content.innerHTML += `<div class="bg-gray-800 p-4 rounded-2xl border-r-4 border-yellow-500 mb-2 text-right">${d.data().text}</div>`; });
                });
            });
        }

        function listenToUserData(uid) {
            onSnapshot(doc(db, "users", uid), (d) => { if (d.exists()) {
                document.getElementById('points-count').innerText = d.data().points;
                if (d.data().referralStepCompleted) document.getElementById('referral-input-container').innerHTML = "<p class='text-green-600 font-bold text-right'>ØªÙ… ØªÙØ¹ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© âœ…</p>";
            }});
        }

        const autoCloseSidebar = () => document.getElementById('sidebar').style.transform = "translateX(100%)";
        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => location.reload());
        document.getElementById('open-sidebar').onclick = () => document.getElementById('sidebar').style.transform = "translateX(0)";
        document.getElementById('close-sidebar').onclick = () => document.getElementById('sidebar').style.transform = "translateX(100%)";
        
        document.getElementById('open-withdraw-btn').onclick = () => { autoCloseSidebar(); document.getElementById('withdraw-modal').classList.remove('hidden'); };
        document.getElementById('open-referral-btn').onclick = () => { autoCloseSidebar(); document.getElementById('referral-modal').classList.remove('hidden'); };

        document.getElementById('open-notifs').onclick = () => { document.getElementById('notifs-modal').classList.remove('hidden'); document.getElementById('notif-dot').classList.add('hidden'); };
        document.getElementById('close-notifs').onclick = () => document.getElementById('notifs-modal').classList.add('hidden');
        document.getElementById('close-withdraw').onclick = () => document.getElementById('withdraw-modal').classList.add('hidden');
        document.getElementById('close-referral').onclick = () => document.getElementById('referral-modal').classList.add('hidden');
        document.getElementById('copy-ref-btn').onclick = () => { navigator.clipboard.writeText(document.getElementById('my-referral-code-display').innerText); window.showTopNotif("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!"); };

        document.getElementById('confirm-ref-btn').onclick = async () => {
            const code = document.getElementById('ref-input-field').value.trim().toUpperCase();
            const myId = auth.currentUser.uid;
            const myRef = doc(db, "users", myId);
            const mySnap = await getDoc(myRef);
            if (code === mySnap.data().referralCode || mySnap.data().referralStepCompleted) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯");
            const q = query(collection(db, "users"), where("referralCode", "==", code));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                await updateDoc(doc(db, "users", querySnapshot.docs[0].id), { points: increment(50) });
                await updateDoc(myRef, { points: increment(25), referralStepCompleted: true });
                window.showTopNotif("Ù…Ø¨Ø±ÙˆÙƒ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 25 Ù†Ù‚Ø·Ø© Ø¥Ø¶Ø§ÙÙŠØ©.");
                location.reload();
            }
        };

        // Ø²Ø± "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ù‡Ù…Ø©"
        document.getElementById('modal-start-btn').onclick = () => {
            if (currentActiveTask && currentActiveTask.url) {
                window.open(currentActiveTask.url, '_blank');
            }
        };

        // Ø²Ø± "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ØªÙ…Ø§Ù…" - Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¥Ø®ÙØ§Ø¡ Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø©
        document.getElementById('modal-confirm-btn').onclick = async () => {
            if (currentActiveTask) {
                try {
                    const uid = auth.currentUser.uid;
                    // 1. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø£Ø¯Ù…Ù† Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                    await addDoc(collection(db, "pending_tasks"), {
                        userId: uid,
                        userName: auth.currentUser.displayName,
                        taskId: currentActiveTask.id,
                        taskTitle: currentActiveTask.title,
                        reward: currentActiveTask.reward,
                        createdAt: serverTimestamp()
                    });

                    // 2. ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø¥ØªÙ…Ø§Ù… Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    // Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ (Ø¯Ù…Ø¬ uid Ùˆ taskId) Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…Ù‡Ù…Ø©
                    const completedRef = doc(db, "completed_tasks", uid + "_" + currentActiveTask.id);
                    await setDoc(completedRef, {
                        userId: uid,
                        taskId: currentActiveTask.id,
                        doneAt: serverTimestamp()
                    });

                    window.showTopNotif("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø£Ø¯Ù…Ù†. Ø³ØªØ®ØªÙÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØªØ¹ÙˆØ¯ Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©.");
                    document.getElementById('task-detail-modal').classList.add('hidden');
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
                    listenToTasks(uid);

                } catch (e) {
                    console.error(e);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£.");
                }
            }
        };

        document.getElementById('add-task-confirm').onclick = async () => {
            const title = document.getElementById('new-task-title').value;
            const desc = document.getElementById('new-task-desc').value;
            const url = document.getElementById('new-task-url').value;
            const reward = parseInt(document.getElementById('new-task-points').value);
            
            if (title && url && !isNaN(reward)) {
                try {
                    await addDoc(collection(db, "tasks"), { 
                        title, description: desc, url, reward, createdAt: serverTimestamp() 
                    });
                    window.showTopNotif("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!");
                    document.getElementById('new-task-title').value = "";
                    document.getElementById('new-task-desc').value = "";
                    document.getElementById('new-task-url').value = "";
                    document.getElementById('new-task-points').value = "";
                } catch (e) { console.error(e); }
            }
        };

        onAuthStateChanged(auth, u => u && handleAuth(u));
    </script>
</body>
</html>
